<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>D3plus Network — Country Filter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  html, body { height: 100%; margin: 0; }
  body {
    display: flex;
    justify-content: flex-start;
    align-items: center;
  }

  #container {
    display: flex;
    flex-direction: row;
    width: 95vw;
    height: 90vh;
  }

  /* Левая колонка */
  #sidebar {
    width: 25%;
    padding: 16px;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    font-size: 14px;
    box-sizing: border-box;
  }

  #description {
    line-height: 1.4;
    color: #333;
  }

  /* Правая колонка */
  #viz {
    flex-grow: 1;
    width: 70%;
    height: 100%;
    margin-left: auto;
  }

  /* Darken edges */
  #viz .d3plus-Links path {
    stroke: #000 !important;
    stroke-opacity: 0.9 !important;
  }

  #controls {
    margin-bottom: 16px;
    background: rgba(255,255,255,.95);
    padding: 8px 12px;
    border-radius: 10px;
  }
  #controls label { margin-right: 6px; }
  #legend { margin-left: 8px; opacity: .75; }

  #countrySelect {
    padding: 6px 18px 6px 8px;
    border: 1px solid #bbb;
    border-radius: 6px;
    background: #f8f8f8;
    font-size: 14px;
    font-family: inherit;
    color: #222;
    outline: none;
    appearance: none;
    transition: border-color 0.2s;
  }
  #countrySelect:focus {
    border-color: #888;
    background: #fff;
  }

  /* Мобильная адаптация */
  @media (max-width: 768px) {
    #container {
      flex-direction: column;   /* вместо row */
      width: 100%;
      height: auto;
    }

    #sidebar {
      width: 100%;
      height: auto;
    }

    #viz {
      width: 100%;
      height: 70vh;  /* чтобы график занимал место */
      margin-left: 0;
      margin-top: 16px;
    }
  }
</style>

  <script src="https://unpkg.com/d3"></script>
  <script src="https://unpkg.com/d3plus@2"></script>

  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

</head>
<body>
  <div id="container">
    <div id="sidebar">
      <h2>Industry Similarity Space</h2>
      <div id="controls">
   
        <select id="countrySelect">
          <option value="">All</option>
        </select><br>
        
      </div>
      <div id="description">
        <p>Grey = selected country is unspecialized</p>
        <p>The space is based on country-specific production data, represents industries as circles sized by their production amounts.</p>
        <p>Lines connect industries co-specialized in the same countries, clustering similar industries while distancing others.</p>
        <p>The industry space helps predict future industrial growth, as countries are more likely to develop specializations in industries connected to their existing ones.</p>
        
      </div>
    </div>
    <div id="viz"></div>
  </div>




  <script>
  (async () => {
  try {
    const [graph, specText] = await Promise.all([
      fetch("d3plus_network.json").then(r => r.json()),
      fetch("spec.csv").then(r => r.ok ? r.text() : "")
    ]);

    const rows = specText ? d3.csvParse(specText) : [];
    const mcpMap = new Map();
    const countrySet = new Set();

    if (rows.length) {
      for (const r of rows) {
        const c = (r["buyer"] || "").trim();
        const i = (r["industry_buy"] || "").trim();
        const vraw = r["m_cp"];
        const v = (vraw === undefined || vraw === null || vraw === "") ? undefined : +vraw;
        if (c && i) {
          mcpMap.set(`${c}|${i}`, v);
          countrySet.add(c);
        }
      }
    } else {
      $("#countrySelect").prop("disabled", true);
      $("#legend").text("Load spec.csv with [buyer, industry_buy, m_cp] to enable filter");
      console.warn("spec.csv missing or empty");
    }

    const countries = Array.from(countrySet).sort();
    for (const c of countries) {
      $("#countrySelect").append(new Option(c, c));
    }

    // Init Select2 AFTER adding options
    $('#countrySelect').select2({
      placeholder: "Select a country",
      allowClear: true,
      width: '100%'
    });

    const nodes = graph.nodes || [];
    const links = graph.links || [];

    const pciVals = nodes.map(n => +n.pci || 0).filter(v => !isNaN(v));
    const pciMin = d3.min(pciVals) ?? 0;
    const pciMax = d3.max(pciVals) ?? 1;
    const pciColor = d3.scaleLinear()
      .domain([pciMin, pciMax])
      .range(["#ffe6e6", "#ff0000"]);

    nodes.forEach(n => {
      const pciVal = +n.pci || 0;
      n.baseColor = pciColor(pciVal);
    });

    const nodeSize = d => (d.size ? Math.max(4, +d.size) : 4);
    const edgeSize = d => (+d.weight || 1);

    let selectedCountry = "";

    function nodeFill(d) {
      if (selectedCountry) {
        const key = `${selectedCountry}|${(d.industry || d.id || d.label || "").toString().trim()}`;
        const v = mcpMap.get(key);
        if (v === 0) return "#B0B0B0";
      }
      return d.baseColor;
    }

    const formatNum = v => isNaN(v) ? "—" : Math.round(v).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    const formatPCI = v => isNaN(v) ? "—" : (Math.round(+v * 100) / 100).toFixed(2);

    const buildTooltip = d => {
      const rows = [];
      if (d.group != null) rows.push(["Group", d.group]);
      if (d.total_industry_prod != null) rows.push(["Production in mln$", formatNum(d.total_industry_prod)]);
      if (d.pci != null) rows.push(["Industry complexity", formatPCI(d.pci)]);
      if (selectedCountry) {
        const key = `${selectedCountry}|${(d.industry || d.id || d.label || "").toString().trim()}`;
        const v = mcpMap.get(key);
        rows.push([`m_cp (${selectedCountry})`, v == null ? "—" : v]);
      }
      return rows;
    };

    const network = new d3plus.Network()
      .select("#viz")
      .nodes(nodes)
      .links(links)
      .size(nodeSize)
      .x("x")
      .y("y")
      .linkSize(edgeSize)
      .linkSizeMin(1.5)
      .linkSizeScale("linear")
      .shapeConfig({
        label: d => d.label || d.id,
        labelConfig: { fontMin: 10, fontMax: 16, textAnchor: "middle" },
        fill: nodeFill,
        stroke: "#111",
        strokeWidth: 1,
        strokeOpacity: 1
      })
      .tooltipConfig({
        title: d => d.label || d.id,
        tbody: buildTooltip
      })
      .zoom(true)
      .render();

    // Handle country change
    $('#countrySelect').on('change', function() {
      selectedCountry = this.value;
      network
        .shapeConfig({ fill: nodeFill })
        .tooltipConfig({
          title: d => d.label || d.id,
          tbody: buildTooltip
        })
        .render();
    });

  } catch (err) {
    console.error(err);
    document.getElementById("viz").innerHTML =
      "<p style='padding:16px;font-family:sans-serif;color:#900'>Failed to load files. Serve over http(s) and ensure d3plus_network.json and spec.csv are in the same folder.</p>";
  }
})();
  </script>
</body>
</html>
